version: '3'
services:
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
      retries: 5

  mlflow:
    build:
      context: .
      dockerfile: docker/Dockerfile.mlflow
    restart: always
    command: >
      mlflow server
      --backend-store-uri postgresql://user:password@postgres:5432/mlflow_db
      --host 0.0.0.0
      --port 5000
    ports:
      - "5000:5000"
    depends_on:
      postgres:
        condition: service_healthy

  # --- NEW SERVICE: Only runs DB migrations ---
  airflow-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://user:password@postgres:5432/airflow_db
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    command: bash -c "airflow db migrate && airflow users create --username admin --password admin --firstname Peter --lastname Pan --role Admin --email admin@example.com"
    depends_on:
      postgres:
        condition: service_healthy

  # --- MAIN SERVICE: Runs Webserver & Scheduler ---
  airflow-run:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    restart: always
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://user:password@postgres:5432/airflow_db
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    volumes:
      - ./dags:/opt/airflow/dags
      - ./scripts:/opt/airflow/scripts
      - ./data:/opt/airflow/data
    ports:
      - "8081:8080"
    command: bash -c "airflow webserver & airflow scheduler"
    depends_on:
      airflow-init:
        condition: service_completed_successfully  # <--- MAGIC LINE: Waits for init to finish!

volumes:
  postgres_data: